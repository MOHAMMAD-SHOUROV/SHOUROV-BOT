module.exports.config = {
  name: "talkvm",
  version: "1.1.1",
  permission: 0,
  credits: " shourov",
  description: "talk voice message reply",
  prefix: false,
  category: "without prefix",
  cooldowns: 0
};

module.exports.run = async function({ api, event, args, Threads }) {
  const axios = require("axios");
  const fs = global.nodemodule["fs-extra"];
  const path = global.nodemodule["path"];
  try {
    const { talk } = global.apiNayan || {};
    if (!talk) return api.sendMessage("Talk API base URL is not configured.", event.threadID, event.messageID);

    // use replied message body if present and no args provided
    let ask = args.join(" ").trim();
    if (!ask && event.messageReply && event.messageReply.body) {
      ask = event.messageReply.body.trim();
    }

    if (!ask) {
      return api.sendMessage("Please enter a message. Example: talkvm hello", event.threadID, event.messageID);
    }

    // encode and call talk API
    const encodedAsk = encodeURIComponent(ask);
    const talkUrl = `${talk}${encodedAsk}`;

    // request talk API (short timeout)
    const res = await axios.get(talkUrl, { timeout: 15_000 }).catch(err => {
      throw new Error("Failed to reach talk API: " + (err.message || err));
    });

    const reply = res?.data?.reply;
    if (!reply || typeof reply !== "string") {
      return api.sendMessage("Talk API did not return a valid reply.", event.threadID, event.messageID);
    }

    // prepare cache path
    const cacheDir = path.resolve(__dirname, "cache");
    if (!fs.existsSync(cacheDir)) fs.mkdirSync(cacheDir, { recursive: true });
    const outPath = path.resolve(cacheDir, `${event.threadID}_${event.senderID}.mp3`);

    // build tts url and download
    const ttsText = encodeURIComponent(reply);
    // tl=tl (Tagalog) like original â€” change to desired language code
    const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${ttsText}&tl=tl&client=tw-ob`;

    // use your existing helper to download (keeps behaviour consistent)
    await global.utils.downloadFile(ttsUrl, outPath).catch(err => {
      // cleanup if partial file exists
      if (fs.existsSync(outPath)) try { fs.unlinkSync(outPath); } catch {}
      throw new Error("Failed to download TTS audio: " + (err.message || err));
    });

    // send file then remove
    return api.sendMessage({ attachment: fs.createReadStream(outPath) }, event.threadID, () => {
      try { fs.unlinkSync(outPath); } catch (e) {}
    }, event.messageID);

  } catch (error) {
    // best-effort cleanup
    try {
      const tmp = require("path").resolve(__dirname, "cache", `${event.threadID}_${event.senderID}.mp3`);
      if (global.nodemodule["fs-extra"].existsSync(tmp)) global.nodemodule["fs-extra"].unlinkSync(tmp);
    } catch (e) {}

    console.error("talkvm error:", error?.response?.data || error?.message || error);
    return api.sendMessage("An unexpected error occurred. Please try again later.", event.threadID, event.messageID);
  }
};